import { DottedGridBackground } from "./backgrounds/dotted-grid-background.slint";
import { LinedGridBackground } from "./backgrounds/lined-grid-background.slint";

export enum GridBackgroundStyle { dots, lines }

export component WorkflowCanvas inherits Rectangle {
	in-out property <float> zoom: 1.0;
	in-out property <length> pan-x: 0px;
	in-out property <length> pan-y: 0px;
	in-out property <brush> canvas-background: #0f141b;

	in-out property <GridBackgroundStyle> grid-style: GridBackgroundStyle.dots;
	in property <bool> use-style-background: true;

	in property <float> min-zoom: 0.2;
	in property <float> max-zoom: 4.0;

	in property <length> minor-step: (self.height + self.width) / 2 / 20;
	in property <int> major-every: 5;
	in property <length> minor-dot-size: self.minor-step / 9;
	in property <float> major-dot-scale: 1.3;
	in property <length> minor-line-width: self.minor-step / 60;
	in property <float> major-line-scale: 1.3;

	in property <brush> dots-canvas-background: #0f141b;
	in property <brush> dots-minor-color: #1d2a3d;
	in property <brush> dots-major-color: #2d3f5a;

	in property <brush> lines-canvas-background: #0b1220;
	in property <brush> lines-minor-color: #1b2430;
	in property <brush> lines-major-color: #334155;

	private property <brush> active-background: root.grid-style == GridBackgroundStyle.dots ? root.dots-canvas-background : root.lines-canvas-background;
	private property <brush> active-minor-color: root.grid-style == GridBackgroundStyle.dots ? root.dots-minor-color : root.lines-minor-color;
	private property <brush> active-major-color: root.grid-style == GridBackgroundStyle.dots ? root.dots-major-color : root.lines-major-color;

	private property <length> drag-origin-pan-x;
	private property <length> drag-origin-pan-y;
	private property <float> zoom-before-change: 1.0;

	function apply-zoom-at(mouse-x: length, mouse-y: length, requested-zoom: float) {
		root.zoom-before-change = root.zoom;
		root.zoom = max(root.min-zoom, min(root.max-zoom, requested-zoom));

		if root.zoom-before-change > 0 && root.zoom != root.zoom-before-change {
			root.pan-x = mouse-x - (mouse-x - root.pan-x) * (root.zoom / root.zoom-before-change);
			root.pan-y = mouse-y - (mouse-y - root.pan-y) * (root.zoom / root.zoom-before-change);
		}
	}

	clip: true;
	background: root.use-style-background ? root.active-background : root.canvas-background;

	if root.grid-style == GridBackgroundStyle.dots : DottedGridBackground {
		x: 0px;
		y: 0px;
		width: parent.width;
		height: parent.height;
		zoom: root.zoom;
		pan-x: root.pan-x;
		pan-y: root.pan-y;
		minor-step: root.minor-step;
		major-every: root.major-every;
		minor-dot-size: root.minor-dot-size;
		major-dot-scale: root.major-dot-scale;
		minor-color: root.active-minor-color;
		major-color: root.active-major-color;
	}

	if root.grid-style == GridBackgroundStyle.lines : LinedGridBackground {
		x: 0px;
		y: 0px;
		width: parent.width;
		height: parent.height;
		zoom: root.zoom;
		pan-x: root.pan-x;
		pan-y: root.pan-y;
		minor-step: root.minor-step;
		major-every: root.major-every;
		minor-line-width: root.minor-line-width;
		major-line-scale: root.major-line-scale;
		minor-color: root.active-minor-color;
		major-color: root.active-major-color;
	}

	TouchArea {
		x: 0px;
		y: 0px;
		width: parent.width;
		height: parent.height;

		changed pressed => {
			if self.pressed {
				root.drag-origin-pan-x = root.pan-x;
				root.drag-origin-pan-y = root.pan-y;
			}
		}

		moved => {
			if self.pressed {
				root.pan-x = root.drag-origin-pan-x + self.mouse-x - self.pressed-x;
				root.pan-y = root.drag-origin-pan-y + self.mouse-y - self.pressed-y;
			}
		}

		scroll-event(event) => {
			if event.delta-y < 0px {
                // Zoom in by 10% for each scroll step, centered around the current cursor position
				root.apply-zoom-at(self.mouse-x, self.mouse-y, root.zoom * 1.1);
			} else if event.delta-y > 0px {
                // Zoom out by 10% for each scroll step, centered around the current cursor position
				root.apply-zoom-at(self.mouse-x, self.mouse-y, root.zoom / 1.1);
			}
			accept
		}
	}
}
